name: Run Tests on Changed Modules

on: [pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'

      - name: Detect changed modules
        id: changed_modules
        run: |
          echo "CHANGED_MODULES=$(git diff --name-only origin/prod | cut -d'/' -f1 | uniq)" >> $GITHUB_ENV

      - name: Run tests on changed modules
        run: |
          for module in $CHANGED_MODULES; do
            ./gradlew :$module:test
          done

      # 테스트 후 Result를 보기위해 Publish Unit Test Results step 추가
      - name: Publish Unit Test Results
        uses: EnricoMi/publish-unit-test-result-action@v1
        if: ${{ always() }}  # 테스트가 실패하여도 Report를 보기 위해 `always`로 설정
        with:
          files: build/test-results/**/*.xml
